<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Donation</title>
    <!-- These lines are links to Google Fonts, which we use to get a nice, modern font called 'Inter' for our text. -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- This line loads the Tailwind CSS framework. Tailwind provides ready-to-use classes (like 'bg-white', 'p-8') that make styling our page much faster. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        /* This creates a gentle, two-color background that fades from a light gray to a soft blue. */
        background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen p-4">
    <!-- The main container of our container
        'flex items-center justify-center' centers the content inside it
        'min-h-screen' makes sure it takes up at least the full height of the screen-->
    <div
      class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200"
    >
    
        <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Donate Now üíù</h1>
        <p class="text-gray-600">Your contribution makes a difference. Thank you for your support.</p>
      </div>
      <div class="space-y-6">
      <form id="donation-form" class="space-y-4">
        <div>
          <label
            for="phone"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Phone Number</label
          >
          <input
            type="tel"
            id="phone"
            name="phone"
            placeholder="e.g., 254712345678"
            required
            class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition duration-300"
          />
        </div>
        <div>
          <label
            for="amount"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Donation Amount (KES)</label
          >
          <input
            type="number"
            id="amount"
            name="amount"
            placeholder="e.g., 50"
            required
            class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition duration-300"
          />
        </div>
        <button
          type="submit"
          class="w-full py-3 px-4 bg-pink-600 hover:bg-pink-700 text-white font-semibold rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2"
        >
          Donate via M-Pesa
        </button>
      </form>
<!--
      <div class="p-8 rounded-2xl bg-gray-50 border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">PayPal Donation</h2>
                This div will be the container where the PayPal button is rendered. -->
                <div id="paypal-button-container" class="mt-4 flex justify-center"></div>
            </div>
      </div>
    -->
      <!-- Message and thank you message container -->
      <div id="message-box" class="mt-6 hidden">
        <div
          id="status-message"
          class="p-4 rounded-lg text-center font-medium shadow-sm"
        ></div>
        <div
          id="thank-you-card"
          class="hidden p-6 rounded-lg bg-green-50 mt-4 text-center"
        >
          <p class="text-xl font-bold text-green-700">Payment Successful!</p>
          <p class="text-green-600 mt-2">
            Thank you for your generous donation!
          </p>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("donation-form");
      const messageBox = document.getElementById("message-box");
      const statusMessage = document.getElementById("status-message");
      const thankYouCard = document.getElementById("thank-you-card");
      const donateButton = form.querySelector("button");

      const PAYPAL_CLIENT_ID = "YOUR_PAYPAL_CLIENT_ID";

      //We listen to the submit event after the donate button is clicked
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        //We get the values the user entered.
        const phone = document.getElementById("phone").value;
        const amount = document.getElementById("amount").value;

        // We hide any previous messages
        messageBox.classList.add("hidden");
        statusMessage.textContent = "";
        thankYouCard.classList.add("hidden");

        try {
          //We disable the button and change its change to let the user know that something is happening
          donateButton.disabled = true;
          donateButton.textContent = "Initiating Transaction...";

          // Send a request to the server to initiate the STK Push
          const response = await fetch(
            "https://chhsv69d-3000.uks1.devtunnels.ms/stk-push",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ phone, amount }),
            }
          );

          //We read the response that comes back from the server
          const data = await response.json();

          if (response.ok) {
            //We show thw message box and update the status message
            messageBox.classList.remove("hidden");
            statusMessage.className =
              "p-4 rounded-lg text-center font-medium shadow-sm bg-blue-50 text-blue-700";
            statusMessage.textContent =
              "Transaction initiated! Please enter your M-Pesa PIN on your phone.";

            // We get the unique transaction ID from the server's response.
            const transactionId = data.transactionId;
            //We start the process to regular check the status of this transaction with the server
            pollTransactionStatus(transactionId);
          } else {
            throw new Error(data.error || "Failed to initiate STK Push.");
          }
        } catch (error) {
          messageBox.classList.remove("hidden");
          statusMessage.className =
            "p-4 rounded-lg text-center font-medium shadow-sm bg-red-50 text-red-700";
          statusMessage.textContent = `Error: ${error.message}`;
        } finally {
          //Always run whether there was an error or not
          //It re-enables the button and change its text to normal
          donateButton.disabled = false;
          donateButton.textContent = "Donate via M-Pesa";
        }
      });

      // This function's job is to repeatedly ask the server for the status of a specific transaction.
      async function pollTransactionStatus(transactionId) {
        const maxAttempts = 20;
        let attempts = 0;

        //SetInterval to run the fn every 3 sec
        const interval = setInterval(async () => {
          attempts++;

          //If we've tried too many times, we show timeout
          if (attempts > maxAttempts) {
            clearInterval(interval); //We stop the polling
            statusMessage.className =
              "p-4 rounded-lg text-center font-medium shadow-sm bg-orange-50 text-orange-700";
            statusMessage.textContent =
              "Transaction timed out. Please try again.";
            return;
          }

          try {
            //We send a request to the server to get the status of the transaction using its unique id
            const response = await fetch(
              `https://chhsv69d-3000.uks1.devtunnels.ms/transaction-status/${transactionId}`
            );
            const data = await response.json();

            //If transaction was a success...
            if (data.status === "success") {
              clearInterval(interval); //We stop the polling
              messageBox.classList.remove("hidden");
              statusMessage.textContent = "";
              thankYouCard.classList.remove("hidden");
              statusMessage.className =
                "p-4 rounded-lg text-center font-medium shadow-sm bg-green-50 text-green-700";
              statusMessage.textContent = "Payment received. Thank you!";
            } else if (data.status === "failed") {
              clearInterval(interval);
              statusMessage.className =
                "p-4 rounded-lg text-center font-medium shadow-sm bg-red-50 text-red-700";
              statusMessage.textContent =
                "Transaction failed. Please try again.";
            }
          } catch (error) {
            console.error("Polling error:", error);
            clearInterval(interval);
            statusMessage.className =
              "p-4 rounded-lg text-center font-medium shadow-sm bg-red-50 text-red-700";
            statusMessage.textContent =
              "An error occurred while checking transaction status.";
          }
        }, 3000); // Poll every 3 seconds
      }

      // === PAYPAL PAYMENT LOGIC ===
    </script>
  </body>
  </html>





<!--
  // We load the paypal sdk dynamically, that gives us access to their buttons
  const script = document.createElement('script');
    script.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=USD`;
    script.onload = () => {
         // This function is provided by the PayPal SDK. It automatically creates and manages the PayPal button.
        window.paypal.Buttons({
            // Here we define the style for the button to make it smaller and more elegant.
            style: {
                layout: 'vertical',
                color: 'gold', // Standard PayPal color
                shape: 'rect',
                label: 'paypal',
                height: 40 // Set the button height to 40px
            },
            // This function is called when the user clicks the PayPal button.
            createOrder: async function(data, actions) {
                try {
                    // We get the amount from a new input field, but you could also get it from the M-Pesa amount field.
                    const amount = document.getElementById('amount-mpesa').value;
                    if (!amount || amount <= 0) {
                         messageBox.classList.remove('hidden');
                         statusMessage.className = 'p-4 rounded-xl text-center font-medium shadow-sm bg-yellow-50 text-yellow-700';
                         statusMessage.textContent = 'Please enter a valid donation amount.';
                         return; // Stop the process if the amount is invalid.
                    }
                    // We send the amount to our server to create a new PayPal order.
                    const response = await fetch('https://chhsv69d-3000.uks1.devtunnels.ms/paypal-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: amount
                        })
                    });
                    const order = await response.json();
                    return order.id; // We return the unique order ID from the server.
                } catch (error) {
                    console.error('Failed to create PayPal order:', error);
                    messageBox.classList.remove('hidden');
                    statusMessage.className = 'p-4 rounded-xl text-center font-medium shadow-sm bg-red-50 text-red-700';
                    statusMessage.textContent = 'Failed to create PayPal order. Please try again.';
                    return null;
                }
            },
            // This function is called after the user approves the payment on the PayPal website.
            onApprove: async function(data, actions) {
                try {
                    // We send the order ID to our server to capture the payment.
                    const response = await fetch(`https://chhsv69d-3000.uks1.devtunnels.ms/paypal-capture/${data.orderID}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const paymentCapture = await response.json();
                    
                    if (paymentCapture.status === 'COMPLETED') {
                        // If the payment is completed, we show the success message.
                        messageBox.classList.remove('hidden');
                        statusMessage.textContent = '';
                        thankYouCard.classList.remove('hidden');
                        statusMessage.className = 'p-4 rounded-xl text-center font-medium shadow-sm bg-green-50 text-green-700';
                        statusMessage.textContent = 'PayPal payment received. Thank you!';
                    } else {
                        // If the payment status is not 'COMPLETED', we show an error.
                        throw new Error('Payment status not completed.');
                    }
                } catch (error) {
                    console.error('Failed to capture PayPal payment:', error);
                    messageBox.classList.remove('hidden');
                    statusMessage.className = 'p-4 rounded-xl text-center font-medium shadow-sm bg-red-50 text-red-700';
                    statusMessage.textContent = 'Failed to capture PayPal payment. Please try again.';
                }
            },
             // This function is called if an error occurs during the payment process.
            onError: function(err) {
                console.error('An error occurred during PayPal payment:', err);
                messageBox.classList.remove('hidden');
                statusMessage.className = 'p-4 rounded-xl text-center font-medium shadow-sm bg-red-50 text-red-700';
                statusMessage.textContent = 'An error occurred during PayPal payment. Please try again.';
            }
        }).render('#paypal-button-container'); // This line tells the SDK where to draw the button.
    };

    // We append the new script to the document body to load it.
    document.body.appendChild(script);

-->